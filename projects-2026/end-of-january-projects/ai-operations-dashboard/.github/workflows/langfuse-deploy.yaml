name: Langfuse Deployment

on:
  push:
    branches: [main]
    paths:
      - 'helm/**'
      - 'evaluation/**'
      - 'alerts/**'
      - '.github/workflows/langfuse-deploy.yaml'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Lint Helm Chart
        run: helm lint helm/langfuse -f helm/langfuse/values.local.yaml

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"

      - name: Run Ruff
        run: ruff check .

      - name: Run MyPy
        run: mypy evaluation alerts --ignore-missing-imports

  deploy-local:
    runs-on: self-hosted
    needs: [lint, test]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Set up k3d
        uses: AbsaOSS/k3d-action@v2
        with:
          cluster-name: langfuse-test

      - name: Deploy to k3d
        run: |
          helm upgrade --install langfuse ./helm/langfuse \
            -f helm/langfuse/values.local.yaml \
            --namespace langfuse \
            --create-namespace \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl get pods -n langfuse
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=langfuse -n langfuse --timeout=300s

  deploy-production:
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name production-cluster --region us-east-1

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Deploy to Production
        run: |
          helm upgrade --install langfuse ./helm/langfuse \
            -f helm/langfuse/values.production.yaml \
            --namespace langfuse-prod \
            --create-namespace \
            --wait \
            --timeout 15m
