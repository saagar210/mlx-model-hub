apiVersion: v1
kind: ConfigMap
metadata:
  name: langfuse-config
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: langfuse
data:
  NEXTAUTH_URL: "http://localhost:3002"
  LANGFUSE_HOST: "http://langfuse-web:3000"
  LANGFUSE_LOG_LEVEL: {{ .Values.langfuse.web.env.LANGFUSE_LOG_LEVEL | default "info" | quote }}
  LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: {{ .Values.langfuse.web.env.LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES | default "false" | quote }}
  NODE_ENV: {{ .Values.langfuse.web.env.NODE_ENV | default "production" | quote }}
  # Redis
  REDIS_HOST: "langfuse-redis"
  REDIS_PORT: "6379"
  # ClickHouse
  CLICKHOUSE_MIGRATION_URL: "clickhouse://langfuse-clickhouse:9000/default"
  CLICKHOUSE_URL: "http://langfuse-clickhouse:8123"
  # S3/LocalStack
  {{- if .Values.localstack.enabled }}
  S3_ENDPOINT: "http://langfuse-localstack:4566"
  S3_BUCKET_NAME: {{ .Values.localstack.s3.bucketName | quote }}
  S3_ACCESS_KEY_ID: "test"
  S3_SECRET_ACCESS_KEY: "test"
  S3_REGION: "us-east-1"
  {{- else if .Values.s3.enabled }}
  S3_ENDPOINT: {{ .Values.s3.endpoint | quote }}
  S3_BUCKET_NAME: {{ .Values.s3.bucket | quote }}
  S3_REGION: {{ .Values.s3.region | quote }}
  {{- end }}
---
{{- if .Values.clickhouse.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-config
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: langfuse
    app.kubernetes.io/component: clickhouse
data:
  config.xml: |
    <?xml version="1.0"?>
    <clickhouse>
        <logger>
            <level>warning</level>
            <console>1</console>
        </logger>
        <listen_host>0.0.0.0</listen_host>
        <http_port>8123</http_port>
        <tcp_port>9000</tcp_port>
        <max_concurrent_queries>100</max_concurrent_queries>
        <max_connections>4096</max_connections>
    </clickhouse>
  retention.sql: |
    -- Apply 7-day TTL to Langfuse tables after they're created
    -- Run this after Langfuse creates its schema
    ALTER TABLE IF EXISTS traces MODIFY TTL created_at + INTERVAL {{ .Values.clickhouse.retention.days }} DAY;
    ALTER TABLE IF EXISTS observations MODIFY TTL start_time + INTERVAL {{ .Values.clickhouse.retention.days }} DAY;
    ALTER TABLE IF EXISTS scores MODIFY TTL timestamp + INTERVAL {{ .Values.clickhouse.retention.days }} DAY;
{{- end }}
